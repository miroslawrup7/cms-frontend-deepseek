import{getProfile,API_BASE}from"./api.js";import{toast,toastError,confirmToast}from"./toast.js";const urlParams=new URLSearchParams(window.location.search),articleId=urlParams.get("id"),titleEl=document.getElementById("article-title"),contentEl=document.getElementById("article-content"),metaEl=document.getElementById("article-meta"),galleryEl=document.getElementById("article-gallery");let likesCount=0,likedByMe=!1;async function loadArticle(){titleEl.textContent="≈Åadowanie‚Ä¶",contentEl.innerHTML="",metaEl.textContent="",galleryEl.innerHTML="";try{const t=await fetch(`${API_BASE}/api/articles/${articleId}`,{credentials:"include"}),e=await t.json();if(!t.ok)throw new Error(e?.message||`B≈ÇƒÖd ${t.status}`);const n=e.article||e;likesCount=Array.isArray(n.likes)?n.likes.length:n.likesCount||0;let a=null;try{a=await getProfile()}catch{}if(a){const t=document.getElementById("comment-form-section");t&&(t.style.display="block")}const i=a&&("admin"===a.role||String(a._id)===String(n.author?._id||n.author));likedByMe=!!(a&&Array.isArray(n.likes)&&n.likes.some(t=>String(t)===String(a._id)));const r=Array.isArray(n.images)?n.images:[],o="number"==typeof n.commentCount?n.commentCount:e.commentCount||0,s=n.author?.email||n.author?.username||"Autor";titleEl.textContent=n.title||"(bez tytu≈Çu)",contentEl.innerHTML=(n.content||"").replace(/\n/g,"<br>");const l=[];s&&l.push(s),n.createdAt&&l.push(fmtDate(n.createdAt)),l.push(`üëç <span id="likes-count">${likesCount}</span>`),l.push(`üí¨ <span id="comments-count">${o}</span>`),metaEl.innerHTML=`\n    <div class="meta-left">\n        ${l.join(" ‚Ä¢ ")}\n    </div>\n    <div class="meta-right">\n        ${!i&&a?`\n        <button id="like-btn"\n                class="btn btn--ghost btn--like"\n                aria-pressed="${likedByMe?"true":"false"}"\n                aria-label="${likedByMe?"Cofnij polubienie":"Polub artyku≈Ç"}">\n            <span class="like-label">${likedByMe?"Lubisz":"Lubiƒô to"}</span>\n        </button>\n        `:""}\n        ${i?`\n        <a id="editArticleBtn" class="btn btn--ghost" href="/new-article.html?id=${n._id}">\n            Edytuj artyku≈Ç\n        </a>\n        <button id="deleteArticleBtn" class="btn btn--danger">Usu≈Ñ artyku≈Ç</button>\n        `:""}\n    </div>\n    `,a&&!i&&document.getElementById("like-btn")?.addEventListener("click",handleLikeToggle),i&&document.getElementById("deleteArticleBtn")?.addEventListener("click",handleDeleteArticle),renderGallery(r)}catch(t){titleEl.textContent="B≈ÇƒÖd",metaEl.textContent="",contentEl.innerHTML=`<p style="color:crimson">${t.message||"Nie uda≈Ço siƒô wczytaƒá artyku≈Çu."}</p>`,galleryEl.innerHTML=""}}async function loadComments(){const t=document.getElementById("comments-container");if(t){t.innerHTML="<p>≈Åadowanie komentarzy‚Ä¶</p>";try{const e=await fetch(`${API_BASE}/api/comments/${articleId}`),n=await e.json(),a=Array.isArray(n)?n.length:0,i=document.getElementById("comments-count");if(i&&(i.textContent=String(a)),!Array.isArray(n)||0===n.length)return void(t.innerHTML="<p>Brak komentarzy.</p>");let r=null;try{r=await getProfile()}catch{}t.innerHTML=n.map(t=>{const e=r&&String(r._id)===String(t.author?._id||t.author),n=r&&"admin"===r.role,a=!(!e&&!n);return`\n        <div class="comment" data-id="${t._id}">\n          <p class="comment-text">${t.text}</p>\n          <div class="comment-meta">\n            <span>${t.author?.username||"Anonim"}</span> ‚Ä¢\n            <span>${new Date(t.createdAt).toLocaleString()}</span>\n            ${a?'\n              <button class="btn--sm btn-edit-comment">Edytuj</button>\n              <button class="btn--sm btn--danger btn-delete-comment">Usu≈Ñ</button>\n            ':""}\n          </div>\n        </div>\n      `}).join("")}catch(e){t.innerHTML='<p style="color:crimson">B≈ÇƒÖd ≈Çadowania komentarzy</p>',toastError("B≈ÇƒÖd ≈Çadowania komentarzy")}}}function fmtDate(t){if(!t)return"";try{return new Date(t).toLocaleDateString("pl-PL",{year:"numeric",month:"long",day:"numeric"})}catch{return""}}function renderGallery(t=[]){if(galleryEl.innerHTML="",!t||0===t.length)return;const e=t.map(t=>`${API_BASE}/${String(t).replace(/^\/+/,"")}`),n=document.createElement("div");n.className="gallery-main",n.innerHTML=`<img src="${e[0]}" alt="">`;const a=document.createElement("div");a.className="thumbs",a.innerHTML=e.map((t,e)=>`<img src="${t}" alt="" data-idx="${e}" class="${0===e?"active":""}">`).join(""),a.addEventListener("click",t=>{const i=t.target.closest("img[data-idx]");if(!i)return;const r=Number(i.dataset.idx);n.querySelector("img").src=e[r],a.querySelectorAll("img").forEach(t=>t.classList.remove("active")),i.classList.add("active")}),galleryEl.appendChild(n),e.length>1&&galleryEl.appendChild(a)}document.getElementById("comments-container")?.addEventListener("click",async t=>{const e=t.currentTarget,n=t.target.closest(".comment");if(!n)return;const a=n.dataset.id;if(t.target.closest(".btn-delete-comment")){if(!await confirmToast({message:"UsunƒÖƒá ten komentarz?",okText:"Usu≈Ñ",cancelText:"Anuluj"}))return;try{const t=await fetch(`${API_BASE}/api/comments/${a}`,{method:"DELETE",credentials:"include"});if(!t.ok)throw new Error((await t.json())?.message||`B≈ÇƒÖd ${t.status}`);n.remove(),toast("Komentarz usuniƒôty.","success"),await loadComments(),e.querySelector(".comment")||(e.innerHTML="<p>Brak komentarzy.</p>")}catch(t){toastError(t.message||"B≈ÇƒÖd usuwania komentarza.")}return}if(t.target.closest(".btn-edit-comment")){if(n.classList.contains("is-editing")||n.querySelector(".edit-comment-text"))return;const t=n.querySelector(".comment-text");if(!t)return;n.dataset.originalHtml=t.innerHTML;const e=t.textContent;t.innerHTML=`\n      <textarea class="edit-comment-text">${e}</textarea>\n      <div class="edit-actions">\n        <button class="btn--sm btn-save-comment">Zapisz</button>\n        <button class="btn--sm btn-cancel-edit">Anuluj</button>\n      </div>\n    `,n.classList.add("is-editing");const a=n.querySelector(".btn-edit-comment");return a&&(a.disabled=!0),void n.querySelector(".edit-comment-text")?.focus()}if(t.target.closest(".btn-cancel-edit")){const t=n.querySelector(".comment-text"),e=n.dataset.originalHtml||t?.textContent||"";t&&(t.innerHTML=e),n.classList.remove("is-editing"),delete n.dataset.originalHtml;const a=n.querySelector(".btn-edit-comment");return void(a&&(a.disabled=!1))}if(t.target.closest(".btn-save-comment")){const t=n.querySelector(".edit-comment-text"),e=(t?.value||"").trim();if(e.length<6)return toastError("Komentarz musi mieƒá co najmniej 6 znak√≥w."),void t?.focus();try{const t=await fetch(`${API_BASE}/api/comments/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({text:e})}),i=await t.json().catch(()=>({}));if(!t.ok)throw new Error(i?.message||`B≈ÇƒÖd ${t.status}`);const r=n.querySelector(".comment-text");r&&(r.innerHTML=i.text),toast("Komentarz zaktualizowany.","success")}catch(t){return void toastError(t.message||"B≈ÇƒÖd zapisu komentarza.")}finally{n.classList.remove("is-editing"),delete n.dataset.originalHtml;const t=n.querySelector(".btn-edit-comment");t&&(t.disabled=!1)}}}),document.getElementById("comment-form")?.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("comment-text"),n=(e?.value||"").trim();if(!n||n.length<6)return toastError("Komentarz musi mieƒá przynajmniej 6 znak√≥w."),void e?.focus();try{const t=await fetch(`${API_BASE}/api/comments/${articleId}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({text:n})});let a={};try{a=await t.json()}catch{}if(!t.ok){const n=a?.message||"B≈ÇƒÖd serwera";return toastError(n),void(400===t.status&&/pusty po odfiltrowaniu|co najmniej 6 znak√≥w|nie mo≈ºe byƒá pusty/i.test(n)&&e&&(e.value="",e.focus()))}e&&(e.value=""),await loadComments()}catch(t){toastError(t?.message||"B≈ÇƒÖd po≈ÇƒÖczenia z serwerem"),e?.focus()}});let likeBusy=!1;async function handleLikeToggle(t){if(likeBusy)return;likeBusy=!0;const e=t.currentTarget;e.disabled=!0;const n=document.getElementById("likes-count"),a=likedByMe,i=likesCount;likedByMe=!likedByMe,likesCount+=likedByMe?1:-1,n&&(n.textContent=String(Math.max(0,likesCount))),e.querySelector(".like-label").textContent=likedByMe?"Lubisz":"Lubiƒô to",e.setAttribute("aria-pressed",likedByMe?"true":"false");try{const t=await fetch(`${API_BASE}/api/articles/${articleId}/like`,{method:"POST",credentials:"include"}),e=await t.json();if(!t.ok)throw new Error(e?.message||`B≈ÇƒÖd ${t.status}`)}catch(t){likedByMe=a,likesCount=i,n&&(n.textContent=String(Math.max(0,likesCount))),e.querySelector(".like-label").textContent=likedByMe?"Lubisz":"Lubiƒô to",e.setAttribute("aria-pressed",likedByMe?"true":"false"),toastError(t.message||"B≈ÇƒÖd polubienia artyku≈Çu")}finally{likeBusy=!1,e.disabled=!1}}async function handleDeleteArticle(){if(await confirmToast({message:"UsunƒÖƒá ten artyku≈Ç?",okText:"Usu≈Ñ",cancelText:"Anuluj"}))try{const t=await fetch(`${API_BASE}/api/articles/${articleId}`,{method:"DELETE",credentials:"include"});if(!t.ok)throw new Error((await t.json())?.message||`B≈ÇƒÖd ${t.status}`);toast("Artyku≈Ç usuniƒôty.","success"),window.location.href="/"}catch(t){toastError(t.message||"B≈ÇƒÖd usuwania artyku≈Çu.")}}document.addEventListener("DOMContentLoaded",()=>{loadArticle(),loadComments()});
//# sourceMappingURL=article.js.map
