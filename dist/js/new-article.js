import{getProfile,API_BASE}from"./api.js";import{toast,toastError}from"./toast.js";document.addEventListener("DOMContentLoaded",async()=>{try{const e=await getProfile();if(!e||!["author","admin"].includes(e.role))return toastError("Brak uprawnień."),void(location.href="/");init()}catch{toastError("Błąd autoryzacji."),location.href="/"}});const pageUrl=new URL(location.href),articleId=pageUrl.searchParams.get("id"),form=document.getElementById("article-form"),titleEl=document.getElementById("title"),contentEl=document.getElementById("content"),imagesInput=document.getElementById("images"),preview=document.getElementById("preview"),existingWrap=document.getElementById("existing-images"),submitBtn=document.getElementById("submit-btn"),MAX_FILES=5,MAX_SIZE=5242880;function init(){if(form&&!form.hasAttribute("novalidate")&&form.setAttribute("novalidate",""),articleId){const e=document.getElementById("page-title");e&&(e.textContent="Edytuj artykuł"),loadArticleForEdit()}imagesInput&&imagesInput.addEventListener("change",handleFilesPreview),form&&form.addEventListener("submit",onSubmit)}function handleFilesPreview(e){preview&&(preview.innerHTML="");const t=Array.from(e&&e.target&&e.target.files?e.target.files:[]);if(t.length>5)return toastError("Maksymalnie 5 plików."),void(imagesInput&&(imagesInput.value=""));for(let e=0;e<t.length;e++){const i=t[e];if(!i.type||!i.type.startsWith("image/"))return toastError("Dozwolone tylko obrazy."),void(imagesInput&&(imagesInput.value=""));if(i.size>5242880)return toastError("Każdy obraz ≤ 5MB."),void(imagesInput&&(imagesInput.value=""));const a=URL.createObjectURL(i),r=document.createElement("img");r.src=a,r.alt=i.name,preview&&preview.appendChild(r)}}async function loadArticleForEdit(){try{const e=await fetch(`${API_BASE}/api/articles/${articleId}`,{credentials:"include"}),t=await e.json();if(!e.ok)throw new Error(t&&t.message||`Błąd ${e.status}`);const i=t.article||t;titleEl&&(titleEl.value=i.title||""),contentEl&&(contentEl.value=i.content||""),Array.isArray(i.images)&&i.images.length&&existingWrap&&(existingWrap.style.display="",existingWrap.innerHTML=["<p>Istniejące obrazy (zaznacz, aby usunąć podczas zapisu):</p>",'<div class="existing-grid">',i.images.map((e,t)=>{const i=`${API_BASE}/${String(e).replace(/^\/+/,"")}`;return`<label class="ex-item"><input type="checkbox" name="removeImages" value="${String(e)}"><img src="${i}" alt="img${t}"></label>`}).join(""),"</div>"].join(""))}catch(e){toastError(e&&e.message?e.message:"Nie udało się wczytać artykułu do edycji.")}}async function onSubmit(e){e.preventDefault(),submitBtn&&(submitBtn.disabled=!0);try{const e=(titleEl&&titleEl.value?titleEl.value:"").trim(),t=(contentEl&&contentEl.value?contentEl.value:"").trim();if(e.length<5)throw new Error("Tytuł musi mieć min. 5 znaków.");if(t.length<20)throw new Error("Treść musi mieć min. 20 znaków.");const i=new FormData;if(i.append("title",e),i.append("content",t),existingWrap){existingWrap.querySelectorAll('input[name="removeImages"]:checked').forEach(e=>{e&&null!=e.value&&i.append("removeImages",e.value)})}const a=Array.from(imagesInput&&imagesInput.files?imagesInput.files:[]);if(a.length>5)throw new Error("Maksymalnie 5 plików.");for(let e=0;e<a.length;e++){const t=a[e];if(!t.type||!t.type.startsWith("image/"))throw new Error("Dozwolone tylko obrazy (MIME).");if(t.size>5242880)throw new Error("Każdy obraz ≤ 5MB.");i.append("images",t)}const r=articleId?"PUT":"POST",n=articleId?`${API_BASE}/api/articles/${articleId}`:`${API_BASE}/api/articles`,o=await fetch(n,{method:r,credentials:"include",body:i});let s={};try{s=await o.json()}catch{}if(403===o.status)throw new Error(s&&s.message||"Brak uprawnień.");if(!o.ok)throw new Error(s&&s.message||`Błąd ${o.status}`);const l=s&&s.article&&s.article._id?s.article._id:articleId||"";location.href=l?`/article.html?id=${l}`:"/"}catch(e){toastError(e&&e.message?e.message:"Błąd zapisu.")}finally{submitBtn&&(submitBtn.disabled=!1)}}
//# sourceMappingURL=new-article.js.map
