import{API_BASE}from"./api.js";import{toast,toastError}from"./toast.js";function isEmail(t){return/^\S+@\S+\.\S+$/.test(String(t||"").trim())}function showError(t){const e=document.getElementById("error");e&&(e.textContent=t,e.hidden=!1,e.style.display=""),"function"==typeof toastError&&toastError(t)}function showSuccess(t){"function"==typeof toast&&toast(t,"success")}function computeSafeRedirect(t){let e=new URLSearchParams(location.search).get("next")||"/";try{const o=new URL(e,location.origin);if(o.origin!==location.origin)return"/";const n=o.pathname.toLowerCase();return n.endsWith("/login.html")||n.endsWith("/register.html")||n.endsWith("/admin.html")&&"admin"!==t?"/":o.pathname+o.search+o.hash}catch{return"/"}}async function onSubmit(t){t.preventDefault();const e=document.getElementById("email"),o=document.getElementById("password"),n=document.getElementById("error"),r=t.submitter||document.querySelector('#loginForm button[type="submit"]');n&&(n.textContent="");const a=e?.value?.trim(),i=o?.value||"";if(!isEmail(a))return showError("Podaj prawidłowy adres e-mail.");if(i.length<6)return showError("Hasło musi mieć co najmniej 6 znaków.");r&&(r.disabled=!0);try{const t=await fetch(`${API_BASE}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:a,password:i})});let e={};try{e=await t.json()}catch{}if(!t.ok)return 429===t.status?showError(e?.message||"Zbyt wiele prób logowania. Spróbuj ponownie za kilka minut."):400===t.status||401===t.status?showError(e?.message||"Nieprawidłowy e-mail lub hasło."):showError(e?.message||`Błąd serwera (${t.status}).`);showSuccess("Zalogowano pomyślnie.");let o=null;try{const t=await fetch(`${API_BASE}/api/users/profile`,{credentials:"include"});if(t.ok){const e=await t.json();o=e?.role||null}}catch{}let n=computeSafeRedirect(o);n&&"/"!==n||(n="admin"===o?"/admin.html":"/"),setTimeout(()=>{location.replace(n)},300)}catch{showError("Błąd połączenia z serwerem.")}finally{r&&(r.disabled=!1)}}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("loginForm");t&&t.addEventListener("submit",onSubmit)});
//# sourceMappingURL=login.js.map
