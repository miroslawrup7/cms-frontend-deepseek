{"version":3,"file":"article.js","names":["getProfile","API_BASE","toast","toastError","confirmToast","urlParams","URLSearchParams","window","location","search","articleId","get","titleEl","document","getElementById","contentEl","metaEl","galleryEl","likesCount","likedByMe","async","loadArticle","textContent","innerHTML","res","fetch","credentials","data","json","ok","Error","message","status","a","article","Array","isArray","likes","length","me","formSection","style","display","isOwner","role","String","_id","author","some","id","images","commentCount","authorLabel","email","username","title","content","replace","parts","push","createdAt","fmtDate","join","addEventListener","handleLikeToggle","handleDeleteArticle","renderGallery","err","loadComments","container","comments","count","counterEl","map","c","isAuthor","isAdmin","canEdit","text","Date","toLocaleString","iso","toLocaleDateString","year","month","day","safe","src","main","createElement","className","thumbs","s","i","e","img","target","closest","idx","Number","dataset","querySelector","querySelectorAll","forEach","t","classList","remove","add","appendChild","currentTarget","commentEl","okText","cancelText","method","contains","textWrap","originalHtml","oldText","editBtn","disabled","focus","original","area","newText","value","trim","headers","body","JSON","stringify","catch","preventDefault","textarea","commentText","msg","test","likeBusy","btn","countEl","prevLiked","prevCount","Math","max","setAttribute","href"],"sources":["article.js"],"mappings":"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","ignoreList":[],"sourcesContent":["import { getProfile, API_BASE } from './api.js'\r\nimport { toast, toastError, confirmToast } from './toast.js'\r\n\r\nconst urlParams = new URLSearchParams(window.location.search)\r\nconst articleId = urlParams.get('id')\r\n\r\nconst titleEl = document.getElementById('article-title')\r\nconst contentEl = document.getElementById('article-content')\r\nconst metaEl = document.getElementById('article-meta')\r\nconst galleryEl = document.getElementById('article-gallery')\r\n\r\nlet likesCount = 0\r\nlet likedByMe = false\r\n\r\nasync function loadArticle() {\r\n  titleEl.textContent = 'Ładowanie…'\r\n  contentEl.innerHTML = ''\r\n  metaEl.textContent = ''\r\n  galleryEl.innerHTML = ''\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}`, {\r\n      credentials: 'include'\r\n    })\r\n    const data = await res.json()\r\n    if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n    const a = data.article || data\r\n\r\n    likesCount = Array.isArray(a.likes) ? a.likes.length : (a.likesCount || 0)\r\n\r\n    let me = null\r\n    try { me = await getProfile() } catch {}\r\n    if (me) {\r\n      const formSection = document.getElementById('comment-form-section')\r\n      if (formSection) formSection.style.display = 'block'\r\n    }\r\n    const isOwner = me && (me.role === 'admin' || String(me._id) === String(a.author?._id || a.author))\r\n    likedByMe = !!(me && Array.isArray(a.likes) && a.likes.some(id => String(id) === String(me._id)))\r\n\r\n    const images = Array.isArray(a.images) ? a.images : []\r\n    const commentCount = typeof a.commentCount === 'number' ? a.commentCount : (data.commentCount || 0)\r\n    const authorLabel = a.author?.email || a.author?.username || 'Autor'\r\n\r\n    titleEl.textContent = a.title || '(bez tytułu)'\r\n    contentEl.innerHTML = (a.content || '').replace(/\\n/g, '<br>')\r\n\r\n    const parts = []\r\n    if (authorLabel) parts.push(authorLabel)\r\n    if (a.createdAt) parts.push(fmtDate(a.createdAt))\r\n    parts.push(`👍 <span id=\"likes-count\">${likesCount}</span>`)\r\n    parts.push(`💬 <span id=\"comments-count\">${commentCount}</span>`)\r\n\r\n    metaEl.innerHTML = `\r\n    <div class=\"meta-left\">\r\n        ${parts.join(' • ')}\r\n    </div>\r\n    <div class=\"meta-right\">\r\n        ${(!isOwner && me) ? `\r\n        <button id=\"like-btn\"\r\n                class=\"btn btn--ghost btn--like\"\r\n                aria-pressed=\"${likedByMe ? 'true' : 'false'}\"\r\n                aria-label=\"${likedByMe ? 'Cofnij polubienie' : 'Polub artykuł'}\">\r\n            <span class=\"like-label\">${likedByMe ? 'Lubisz' : 'Lubię to'}</span>\r\n        </button>\r\n        ` : ''}\r\n        ${isOwner ? `\r\n        <a id=\"editArticleBtn\" class=\"btn btn--ghost\" href=\"/new-article.html?id=${a._id}\">\r\n            Edytuj artykuł\r\n        </a>\r\n        <button id=\"deleteArticleBtn\" class=\"btn btn--danger\">Usuń artykuł</button>\r\n        ` : ''}\r\n    </div>\r\n    `\r\n\r\n    if (me && !isOwner) {\r\n      document.getElementById('like-btn')?.addEventListener('click', handleLikeToggle)\r\n    }\r\n\r\n    if (isOwner) {\r\n      document.getElementById('deleteArticleBtn')?.addEventListener('click', handleDeleteArticle)\r\n    }\r\n\r\n    renderGallery(images)\r\n  } catch (err) {\r\n    titleEl.textContent = 'Błąd'\r\n    metaEl.textContent = ''\r\n    contentEl.innerHTML = `<p style=\"color:crimson\">${err.message || 'Nie udało się wczytać artykułu.'}</p>`\r\n    galleryEl.innerHTML = ''\r\n  }\r\n}\r\n\r\nasync function loadComments() {\r\n  const container = document.getElementById('comments-container')\r\n  if (!container) return\r\n\r\n  container.innerHTML = '<p>Ładowanie komentarzy…</p>'\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/comments/${articleId}`)\r\n    const comments = await res.json()\r\n\r\n    // 🔧 Ustaw licznik komentarzy na aktualną liczbę (bez inkrementacji)\r\n    const count = Array.isArray(comments) ? comments.length : 0\r\n    const counterEl = document.getElementById('comments-count')\r\n    if (counterEl) counterEl.textContent = String(count)\r\n\r\n    if (!Array.isArray(comments) || comments.length === 0) {\r\n      container.innerHTML = '<p>Brak komentarzy.</p>'\r\n      return\r\n    }\r\n\r\n    let me = null\r\n    try { me = await getProfile() } catch {}\r\n\r\n    container.innerHTML = comments.map(c => {\r\n      const isAuthor = me && String(me._id) === String(c.author?._id || c.author)\r\n      const isAdmin  = me && me.role === 'admin'\r\n      const canEdit  = !!(isAuthor || isAdmin)\r\n\r\n      return `\r\n        <div class=\"comment\" data-id=\"${c._id}\">\r\n          <p class=\"comment-text\">${c.text}</p>\r\n          <div class=\"comment-meta\">\r\n            <span>${c.author?.username || 'Anonim'}</span> •\r\n            <span>${new Date(c.createdAt).toLocaleString()}</span>\r\n            ${canEdit ? `\r\n              <button class=\"btn--sm btn-edit-comment\">Edytuj</button>\r\n              <button class=\"btn--sm btn--danger btn-delete-comment\">Usuń</button>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n      `\r\n    }).join('')\r\n  } catch (err) {\r\n    container.innerHTML = '<p style=\"color:crimson\">Błąd ładowania komentarzy</p>'\r\n    toastError('Błąd ładowania komentarzy')\r\n  }\r\n}\r\n\r\n// ZMIANA 1: Usunięto duplikat renderComments – niepotrzebny, loadComments renderuje bezpośrednio\r\n// ZMIANA 2: Usunięto obsługę kliknięć na comments-list – starsza wersja, mniej kompletna\r\n\r\ndocument.getElementById('comments-container')?.addEventListener('click', async (e) => {\r\n  const container = e.currentTarget\r\n  const commentEl = e.target.closest('.comment')\r\n  if (!commentEl) return\r\n  const id = commentEl.dataset.id\r\n\r\n  // Usuń komentarz\r\n  if (e.target.closest('.btn-delete-comment')) {\r\n    const ok = await confirmToast({\r\n      message: 'Usunąć ten komentarz?',\r\n      okText: 'Usuń',\r\n      cancelText: 'Anuluj'\r\n    })\r\n    if (!ok) return\r\n\r\n    try {\r\n      const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include'\r\n      })\r\n      if (!res.ok) throw new Error((await res.json())?.message || `Błąd ${res.status}`)\r\n      commentEl.remove()\r\n      toast('Komentarz usunięty.', 'success')\r\n      await loadComments() \r\n\r\n\r\n      if (!container.querySelector('.comment')) {\r\n        container.innerHTML = '<p>Brak komentarzy.</p>'\r\n      }\r\n    } catch (err) {\r\n      toastError(err.message || 'Błąd usuwania komentarza.')\r\n    }\r\n    return\r\n  }\r\n\r\n  // Wejdź w tryb edycji\r\n  if (e.target.closest('.btn-edit-comment')) {\r\n    if (commentEl.classList.contains('is-editing') ||\r\n        commentEl.querySelector('.edit-comment-text')) return\r\n\r\n    const textWrap = commentEl.querySelector('.comment-text')\r\n    if (!textWrap) return\r\n\r\n    commentEl.dataset.originalHtml = textWrap.innerHTML\r\n    const oldText = textWrap.textContent\r\n    textWrap.innerHTML = `\r\n      <textarea class=\"edit-comment-text\">${oldText}</textarea>\r\n      <div class=\"edit-actions\">\r\n        <button class=\"btn--sm btn-save-comment\">Zapisz</button>\r\n        <button class=\"btn--sm btn-cancel-edit\">Anuluj</button>\r\n      </div>\r\n    `\r\n    commentEl.classList.add('is-editing')\r\n\r\n    const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n    if (editBtn) editBtn.disabled = true\r\n\r\n    commentEl.querySelector('.edit-comment-text')?.focus()\r\n    return\r\n  }\r\n\r\n  // Anuluj edycję\r\n  if (e.target.closest('.btn-cancel-edit')) {\r\n    const textWrap = commentEl.querySelector('.comment-text')\r\n    const original = commentEl.dataset.originalHtml || textWrap?.textContent || ''\r\n    if (textWrap) textWrap.innerHTML = original\r\n\r\n    commentEl.classList.remove('is-editing')\r\n    delete commentEl.dataset.originalHtml\r\n\r\n    const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n    if (editBtn) editBtn.disabled = false\r\n    return\r\n  }\r\n\r\n  // Zapisz edycję\r\n  if (e.target.closest('.btn-save-comment')) {\r\n    const area = commentEl.querySelector('.edit-comment-text')\r\n    const newText = (area?.value || '').trim()\r\n    if (newText.length < 6) {\r\n      toastError('Komentarz musi mieć co najmniej 6 znaków.')\r\n      area?.focus()\r\n      return\r\n    }\r\n\r\n    try {\r\n      const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n        method: 'PUT',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify({ text: newText })\r\n      })\r\n      const data = await res.json().catch(() => ({}))\r\n      if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n\r\n      const textWrap = commentEl.querySelector('.comment-text')\r\n      if (textWrap) textWrap.innerHTML = data.text\r\n\r\n      toast('Komentarz zaktualizowany.', 'success')\r\n    } catch (err) {\r\n      toastError(err.message || 'Błąd zapisu komentarza.')\r\n      return\r\n    } finally {\r\n      commentEl.classList.remove('is-editing')\r\n      delete commentEl.dataset.originalHtml\r\n      const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n      if (editBtn) editBtn.disabled = false\r\n    }\r\n  }\r\n})\r\n\r\n// Formularz komentarza\r\ndocument.getElementById(\"comment-form\")?.addEventListener(\"submit\", async (e) => {\r\n  e.preventDefault()\r\n\r\n  const textarea = document.getElementById(\"comment-text\")\r\n  const commentText = (textarea?.value || \"\").trim()\r\n\r\n  if (!commentText || commentText.length < 6) {\r\n    toastError(\"Komentarz musi mieć przynajmniej 6 znaków.\")\r\n    textarea?.focus()\r\n    return\r\n  }\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/comments/${articleId}`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      credentials: \"include\",\r\n      body: JSON.stringify({ text: commentText })\r\n    })\r\n\r\n    let data = {}\r\n    try { data = await res.json() } catch {}\r\n\r\n    if (!res.ok) {\r\n      const msg = data?.message || \"Błąd serwera\"\r\n      toastError(msg)\r\n\r\n      if (\r\n        res.status === 400 &&\r\n        /pusty po odfiltrowaniu|co najmniej 6 znaków|nie może być pusty/i.test(msg)\r\n      ) {\r\n        if (textarea) {\r\n          textarea.value = \"\"\r\n          textarea.focus()\r\n        }\r\n      }\r\n      return\r\n    }\r\n\r\n    if (textarea) textarea.value = \"\"\r\n    await loadComments()\r\n  } catch (err) {\r\n    toastError(err?.message || \"Błąd połączenia z serwerem\")\r\n    textarea?.focus()\r\n  }\r\n})\r\n\r\nfunction fmtDate(iso) {\r\n  if (!iso) return ''\r\n  try {\r\n    const d = new Date(iso)\r\n    return d.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' })\r\n  } catch { return '' }\r\n}\r\n\r\nfunction renderGallery(images = []) {\r\n  galleryEl.innerHTML = ''\r\n  if (!images || images.length === 0) return\r\n\r\n  const safe = images.map(src => `${API_BASE}/${String(src).replace(/^\\/+/, '')}`)\r\n\r\n  const main = document.createElement('div')\r\n  main.className = 'gallery-main'\r\n  main.innerHTML = `<img src=\"${safe[0]}\" alt=\"\">`\r\n\r\n  const thumbs = document.createElement('div')\r\n  thumbs.className = 'thumbs'\r\n  thumbs.innerHTML = safe.map((s, i) =>\r\n    `<img src=\"${s}\" alt=\"\" data-idx=\"${i}\" class=\"${i === 0 ? 'active' : ''}\">`\r\n  ).join('')\r\n\r\n  thumbs.addEventListener('click', (e) => {\r\n    const img = e.target.closest('img[data-idx]')\r\n    if (!img) return\r\n    const idx = Number(img.dataset.idx)\r\n    main.querySelector('img').src = safe[idx]\r\n    thumbs.querySelectorAll('img').forEach(t => t.classList.remove('active'))\r\n    img.classList.add('active')\r\n  })\r\n\r\n  galleryEl.appendChild(main)\r\n  if (safe.length > 1) galleryEl.appendChild(thumbs)\r\n}\r\n\r\nlet likeBusy = false\r\n\r\nasync function handleLikeToggle(e) {\r\n  if (likeBusy) return\r\n  likeBusy = true\r\n  const btn = e.currentTarget\r\n  btn.disabled = true\r\n\r\n  const countEl = document.getElementById('likes-count')\r\n  const prevLiked = likedByMe\r\n  const prevCount = likesCount\r\n\r\n  likedByMe = !likedByMe\r\n  likesCount += likedByMe ? 1 : -1\r\n  if (countEl) countEl.textContent = String(Math.max(0, likesCount))\r\n  btn.querySelector('.like-label').textContent = likedByMe ? 'Lubisz' : 'Lubię to'\r\n  btn.setAttribute('aria-pressed', likedByMe ? 'true' : 'false')\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}/like`, {\r\n      method: 'POST',\r\n      credentials: 'include'\r\n    })\r\n    const data = await res.json()\r\n    if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n  } catch (err) {\r\n    likedByMe = prevLiked\r\n    likesCount = prevCount\r\n    if (countEl) countEl.textContent = String(Math.max(0, likesCount))\r\n    btn.querySelector('.like-label').textContent = likedByMe ? 'Lubisz' : 'Lubię to'\r\n    btn.setAttribute('aria-pressed', likedByMe ? 'true' : 'false')\r\n    toastError(err.message || 'Błąd polubienia artykułu')\r\n  } finally {\r\n    likeBusy = false\r\n    btn.disabled = false\r\n  }\r\n}\r\n\r\nasync function handleDeleteArticle() {\r\n  const confirmed = await confirmToast({\r\n    message: 'Usunąć ten artykuł?',\r\n    okText: 'Usuń',\r\n    cancelText: 'Anuluj'\r\n  })\r\n  if (!confirmed) return\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}`, {\r\n      method: 'DELETE',\r\n      credentials: 'include'\r\n    })\r\n    if (!res.ok) throw new Error((await res.json())?.message || `Błąd ${res.status}`)\r\n    toast('Artykuł usunięty.', 'success')\r\n    window.location.href = '/'\r\n  } catch (err) {\r\n    toastError(err.message || 'Błąd usuwania artykułu.')\r\n  }\r\n}\r\n\r\n// Inicjalizacja\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  loadArticle()\r\n  loadComments()\r\n})"]}